<!DOCTYPE html><html><head>
      <title>lab2_report_template</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/dministrator/.vscode-server/extensions/shd101wyy.markdown-preview-enhanced-0.8.20/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="lab2-实验报告物理内存管理与虚拟地址转换">Lab2 实验报告：物理内存管理与虚拟地址转换 </h1>
<p><strong>学号</strong>: 202311081040<br>
<strong>姓名</strong>: [待填充]<br>
<strong>日期</strong>: 2025年11月11日<br>
<strong>实验代码</strong>: Lab2 - 物理内存管理与虚拟地址转换</p>
<hr>
<h2 id="一-实验目的与意义">一、实验目的与意义 </h2>
<h3 id="11-实验总体目标">1.1 实验总体目标 </h3>
<p>本实验旨在深入理解操作系统中物理内存管理和虚拟地址转换的核心机制。通过实现 First-Fit 连续内存分配算法、虚拟地址转换机制以及页表管理，掌握现代操作系统内存管理的基本原理，为后续的进程管理、虚拟内存等高级特性奠定基础。</p>
<h3 id="12-具体学习目标">1.2 具体学习目标 </h3>
<ol>
<li>
<p><strong>理解物理内存管理机制</strong> (15%)</p>
<ul>
<li>掌握 First-Fit (FF) 连续物理内存分配算法的原理和实现</li>
<li>理解空闲块链表的数据结构和维护方式</li>
<li>学习内存分配和释放的实现原理，特别是相邻块合并的策略</li>
<li>理解页面和块的概念，以及引用计数的作用</li>
</ul>
</li>
<li>
<p><strong>理解分页机制和虚拟地址转换</strong> (25%)</p>
<ul>
<li>掌握 x86 保护模式下两级页表结构（PDE、PTE）的详细含义</li>
<li>理解虚拟地址到物理地址的完整转换过程</li>
<li>学习页表项的标志位含义（P、W、U、A、D等）</li>
<li>理解 TLB 缓存在地址转换中的作用</li>
<li>掌握页访问异常的处理机制</li>
</ul>
</li>
<li>
<p><strong>实现完整的内存管理系统</strong> (35%)</p>
<ul>
<li>实现 First-Fit 算法的四个核心函数：初始化、映射、分配、释放</li>
<li>实现虚拟到物理地址的转换函数（get_pte）</li>
<li>实现页表项的清除和回收函数（page_remove_pte）</li>
<li>正确处理内存碎片化问题</li>
</ul>
</li>
<li>
<p><strong>掌握操作系统编程技能</strong> (25%)</p>
<ul>
<li>学会使用 C 语言和汇编语言混合编程</li>
<li>掌握调试技巧，如使用 GDB 和 QEMU 调试器</li>
<li>理解内核编程的特殊之处（如禁用中断、操作寄存器等）</li>
<li>学会分析编译链接过程和二进制程序结构</li>
</ul>
</li>
</ol>
<hr>
<h2 id="二-实验背景与基础知识">二、实验背景与基础知识 </h2>
<h3 id="21-x86-内存寻址模式演变">2.1 x86 内存寻址模式演变 </h3>
<p>在 x86 架构的发展过程中，内存寻址经历了多个阶段：</p>
<p><strong>实模式 (Real Mode)</strong></p>
<ul>
<li>地址空间：1MB</li>
<li>寻址方式：段:偏移，即 物理地址 = 段基址 × 16 + 偏移</li>
<li>优点：兼容性好，编程简单</li>
<li>缺点：无法有效利用大容量内存</li>
</ul>
<p><strong>保护模式 (Protected Mode)</strong></p>
<ul>
<li>地址空间：4GB（32位）</li>
<li>寻址方式：段机制 + 分页机制（两层次）</li>
<li>优点：内存保护、虚拟内存支持</li>
<li>缺点：编程复杂度高</li>
</ul>
<p>uCore 采用保护模式，使用分页机制管理内存，这是现代操作系统的标准做法。</p>
<h3 id="22-分页机制的核心概念">2.2 分页机制的核心概念 </h3>
<p><strong>页 (Page) 与页框 (Page Frame)</strong></p>
<ul>
<li>页：虚拟地址空间中的固定大小单位（通常为 4KB）</li>
<li>页框：物理地址空间中的固定大小单位（也是 4KB）</li>
<li>虚拟页与物理页框的映射通过页表维护</li>
</ul>
<p><strong>两级页表结构</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>虚拟地址 (32位)
│
├─ 高10位 (PDX) → 页目录索引
├─ 中10位 (PTX) → 页表索引
└─ 低12位 (PGOFF) → 页内偏移
│
页目录表 (PD)
│
└─ PDE (页目录项) → 指向页表
    │
    页表 (PT)
    │
    └─ PTE (页表项) → 指向物理页框
</code></pre><p><strong>虚拟地址转换过程 (6步)</strong></p>
<ol>
<li>CPU 取得虚拟地址</li>
<li>提取高10位（PDX）作为页目录表的索引</li>
<li>从页目录表中取得页表的物理地址（PDE）</li>
<li>提取中间10位（PTX）作为页表的索引</li>
<li>从页表中取得物理页框的地址（PTE）</li>
<li>用低12位（PGOFF）与物理页框地址结合得到最终物理地址</li>
</ol>
<h3 id="23-页表项的结构与标志位">2.3 页表项的结构与标志位 </h3>
<p>x86 页表项 (PTE) 的 32 位结构：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────┐
│ 高20位（物理页框号） │ 低12位（标志位和保留位）  │
└─────────────────────────────────────────────────────────────┘

标志位含义：
- P (Present)    : 0=页面未在内存中，1=页面在内存中
- W (Write)      : 0=只读，1=可读写
- U (User)       : 0=内核级，1=用户级
- A (Accessed)   : 1=该页被访问过
- D (Dirty)      : 1=该页被修改过
- C (Cache)      : 缓存控制位
</code></pre><p>这些标志位对于虚拟内存的实现至关重要，特别是 P 位（用于实现缺页异常）和 D 位（用于脏页跟踪）。</p>
<hr>
<h2 id="三-练习1first-fit-连续物理内存分配">三、练习1：First-Fit 连续物理内存分配 </h2>
<h3 id="31-需求分析">3.1 需求分析 </h3>
<p>First-Fit 算法维护一个有序的空闲块链表，分配时查找第一个足够大的块，释放时通过地址有序插入并尝试合并相邻块。</p>
<p><strong>关键设计决策</strong>：</p>
<ul>
<li>空闲块在链表中<strong>按物理地址升序</strong>排列</li>
<li>每个块的首页记录块大小，其他页为0</li>
<li>分配时可能分裂块，释放时尝试向前和向后合并</li>
</ul>
<h3 id="32-实现设计">3.2 实现设计 </h3>
<h4 id="321-default_init">3.2.1 default_init() </h4>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">default_init</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">list_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>free_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nr_free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>作用</strong>：初始化全局空闲块链表和计数器</p>
<h4 id="322-default_init_memmap">3.2.2 default_init_memmap() </h4>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">default_init_memmap</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>base<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>p <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token comment">// 初始化每一页</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> p <span class="token operator">!=</span> base <span class="token operator">+</span> n<span class="token punctuation">;</span> p <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">PageReserved</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">SetPageProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 标记为属性页</span>
        p<span class="token operator">-&gt;</span>property <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">set_page_ref</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_add_before</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>free_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>page_link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 每页都加入链表</span>
    <span class="token punctuation">}</span>
    nr_free <span class="token operator">+=</span> n<span class="token punctuation">;</span>
    base<span class="token operator">-&gt;</span>property <span class="token operator">=</span> n<span class="token punctuation">;</span>              <span class="token comment">// 首页记录块大小</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>关键点</strong>：</p>
<ul>
<li>每一页都加入链表中（不只是首页）</li>
<li>首页的 <code>property</code> 记录块大小</li>
<li>其他页的 <code>property</code> 为0</li>
<li>设置 <code>PG_property</code> 标志表示有效的空闲页</li>
</ul>
<h4 id="323-default_alloc_pages">3.2.3 default_alloc_pages() </h4>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span><span class="token function">default_alloc_pages</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> nr_free<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">list_entry_t</span> <span class="token operator">*</span>le<span class="token punctuation">,</span> <span class="token operator">*</span>len<span class="token punctuation">;</span>
    le <span class="token operator">=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">;</span>

    <span class="token comment">// 线性扫描找第一个足够大的块</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>le<span class="token operator">=</span><span class="token function">list_next</span><span class="token punctuation">(</span>le<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span> page_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>property <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 找到足够大的块</span>
        <span class="token keyword keyword-int">int</span> i<span class="token punctuation">;</span>
        <span class="token comment">// 删除前n个页</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          len <span class="token operator">=</span> <span class="token function">list_next</span><span class="token punctuation">(</span>le<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pp <span class="token operator">=</span> <span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span> page_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">SetPageReserved</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 标记为已分配</span>
          <span class="token function">ClearPageProperty</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 清除可用标记</span>
          <span class="token function">list_del</span><span class="token punctuation">(</span>le<span class="token punctuation">)</span><span class="token punctuation">;</span>
          le <span class="token operator">=</span> len<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果有剩余，更新剩余部分</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>property<span class="token operator">&gt;</span>n<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token punctuation">(</span><span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span>page_link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>property <span class="token operator">=</span> p<span class="token operator">-&gt;</span>property <span class="token operator">-</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">ClearPageProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SetPageReserved</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nr_free <span class="token operator">-=</span> n<span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> p<span class="token punctuation">;</span>  <span class="token comment">// 返回已分配块首页</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>算法流程</strong>：</p>
<ol>
<li><strong>查找</strong>：线性扫描链表找第一个 <code>property &gt;= n</code> 的块</li>
<li><strong>删除</strong>：将前 n 个页从链表删除</li>
<li><strong>分裂</strong>：若块大于 n，更新剩余部分的 property</li>
<li><strong>标记</strong>：标记为已分配，减少 nr_free</li>
<li><strong>返回</strong>：返回已分配块的首页指针</li>
</ol>
<h4 id="324-default_free_pages">3.2.4 default_free_pages() </h4>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">default_free_pages</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>base<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">PageReserved</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 按地址顺序找插入位置</span>
    <span class="token class-name">list_entry_t</span> <span class="token operator">*</span>le <span class="token operator">=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>le<span class="token operator">=</span><span class="token function">list_next</span><span class="token punctuation">(</span>le<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      p <span class="token operator">=</span> <span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span> page_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>p<span class="token operator">&gt;</span>base<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 找到第一个地址更高的块</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将释放的n个页加入链表</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span>p<span class="token operator">=</span>base<span class="token punctuation">;</span>p<span class="token operator">&lt;</span>base<span class="token operator">+</span>n<span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">list_add_before</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>page_link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 初始化释放块</span>
    base<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">set_page_ref</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ClearPageProperty</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SetPageProperty</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    base<span class="token operator">-&gt;</span>property <span class="token operator">=</span> n<span class="token punctuation">;</span>
    
    <span class="token comment">// 向后合并：检查是否与后继块相邻</span>
    p <span class="token operator">=</span> <span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span>page_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span> base<span class="token operator">+</span>n <span class="token operator">==</span> p <span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 物理地址连续</span>
      base<span class="token operator">-&gt;</span>property <span class="token operator">+=</span> p<span class="token operator">-&gt;</span>property<span class="token punctuation">;</span>
      p<span class="token operator">-&gt;</span>property <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 向前合并：检查是否与前驱块相邻</span>
    le <span class="token operator">=</span> <span class="token function">list_prev</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>page_link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span> page_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>le<span class="token operator">!=</span><span class="token operator">&amp;</span>free_list <span class="token operator">&amp;&amp;</span> p<span class="token operator">==</span>base<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// p是base的直接前驱</span>
      <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span>le<span class="token operator">!=</span><span class="token operator">&amp;</span>free_list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>property<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 找到有效的前驱块</span>
          p<span class="token operator">-&gt;</span>property <span class="token operator">+=</span> base<span class="token operator">-&gt;</span>property<span class="token punctuation">;</span>
          base<span class="token operator">-&gt;</span>property <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        le <span class="token operator">=</span> <span class="token function">list_prev</span><span class="token punctuation">(</span>le<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">=</span> <span class="token function">le2page</span><span class="token punctuation">(</span>le<span class="token punctuation">,</span>page_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    nr_free <span class="token operator">+=</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>算法流程</strong>：</p>
<ol>
<li><strong>位置</strong>：找到第一个地址大于 base 的块作为插入点</li>
<li><strong>插入</strong>：将释放的 n 个页按地址顺序插入链表</li>
<li><strong>初始化</strong>：设置块大小为 n</li>
<li><strong>后向合并</strong>：若 base+n 等于后继块首地址则合并</li>
<li><strong>前向合并</strong>：若前驱块末地址等于 base 则合并</li>
</ol>
<h3 id="33-问题回答">3.3 问题回答 </h3>
<h4 id="q1-first-fit-有什么改进空间">Q1: First-Fit 有什么改进空间？ </h4>
<p><strong>答</strong>：是的，主要包括以下方向：</p>
<p><strong>(1) 查找效率优化</strong></p>
<ul>
<li>当前：O(n) 线性查找，最坏情况需要遍历所有块</li>
<li>改进：使用二叉查找树或红黑树，复杂度降至 O(log n)</li>
<li>优点：适合块很多的场景</li>
<li>示例代码结构：<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">rb_node</span> <span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>left<span class="token punctuation">,</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></li>
</ul>
<p><strong>(2) Buddy System 算法</strong></p>
<ul>
<li>原理：块大小必须是 2^n，分裂和合并都在指数间进行</li>
<li>优点：
<ul>
<li>消除外部碎片</li>
<li>合并操作高效（只需比较块大小）</li>
<li>CPU缓存友好</li>
</ul>
</li>
<li>缺点：可能产生内碎片</li>
<li>应用：Linux 内核采用此算法</li>
</ul>
<p><strong>(3) 缓存优化</strong></p>
<ul>
<li>记录上次分配的位置，下次从该位置开始搜索</li>
<li>优点：局部性好，提高 CPU 缓存命中率</li>
<li>示例：<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token class-name">list_entry_t</span> <span class="token operator">*</span>alloc_hint <span class="token operator">=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">;</span>
</code></pre></li>
</ul>
<p><strong>(4) 延迟合并</strong></p>
<ul>
<li>不立即合并相邻块，而是标记脏块</li>
<li>只在碎片达到阈值时执行全局合并</li>
<li>优点：减少合并开销</li>
<li>缺点：可能浪费内存</li>
</ul>
<p><strong>(5) 多级管理</strong></p>
<ul>
<li>按块大小分类维护多条链表</li>
<li>分配时直接定位合适的链表，不需遍历所有块</li>
<li>类似 Slab Allocator</li>
</ul>
<p><strong>性能对比</strong>：</p>
<table>
<thead>
<tr>
<th>算法</th>
<th>查找</th>
<th>合并</th>
<th>碎片</th>
<th>实现复杂度</th>
</tr>
</thead>
<tbody>
<tr>
<td>First-Fit</td>
<td>O(n)</td>
<td>O(n)</td>
<td>较多</td>
<td>低</td>
</tr>
<tr>
<td>Buddy</td>
<td>O(log n)</td>
<td>O(1)</td>
<td>少</td>
<td>中</td>
</tr>
<tr>
<td>树形</td>
<td>O(log n)</td>
<td>O(log n)</td>
<td>较多</td>
<td>高</td>
</tr>
<tr>
<td>Slab</td>
<td>O(1)</td>
<td>O(1)</td>
<td>少</td>
<td>高</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="四-练习2虚拟地址到页表项转换get_pte">四、练习2：虚拟地址到页表项转换（get_pte） </h2>
<h3 id="41-已完成的实现">4.1 已完成的实现 </h3>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token class-name">pte_t</span> <span class="token operator">*</span><span class="token function">get_pte</span><span class="token punctuation">(</span><span class="token class-name">pde_t</span> <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token class-name">uintptr_t</span> la<span class="token punctuation">,</span> bool create<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pde_t</span> <span class="token operator">*</span>pdep <span class="token operator">=</span> <span class="token operator">&amp;</span>pgdir<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>la<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// (1) 获取PDE地址</span>
    
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>pdep <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment">// (2) 检查页表是否存在</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>create <span class="token operator">||</span> <span class="token punctuation">(</span>page <span class="token operator">=</span> <span class="token function">alloc_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                <span class="token comment">// 若不存在且不创建则返回NULL</span>
        <span class="token punctuation">}</span>
        <span class="token function">set_page_ref</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// (4) 设置引用计数</span>
        <span class="token class-name">uintptr_t</span> pa <span class="token operator">=</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// (5) 获取页表物理地址</span>
        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token function">KADDR</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// (6) 清零页表</span>
        <span class="token operator">*</span>pdep <span class="token operator">=</span> pa <span class="token operator">|</span> PTE_U <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_P<span class="token punctuation">;</span>  <span class="token comment">// (7) 设置PDE权限位</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pte_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PDE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pdep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token function">PTX</span><span class="token punctuation">(</span>la<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// (8) 返回PTE地址</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="42-地址转换原理">4.2 地址转换原理 </h3>
<p><strong>虚拟地址格式</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>虚拟地址 LA = 32 位
 ┌─────────────────────────────────────────┐
 │ PDX(10位) │ PTX(10位) │ PGOFF(12位)     │
 └─────────────────────────────────────────┘
  [31:22]     [21:12]     [11:0]
</code></pre><p><strong>转换步骤</strong>：</p>
<ol>
<li>提取 PDX 获得 PDE 索引</li>
<li>查询 PDE 获得页表地址</li>
<li>提取 PTX 获得 PTE 索引</li>
<li>查询 PTE 获得物理页地址</li>
<li>提取 PGOFF 获得页内偏移</li>
</ol>
<p><strong>具体例子</strong>：虚拟地址 <code>0xC0001234</code> → 物理地址 <code>0x00001234</code></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>虚拟地址 0xC0001234 = 1100_0000_0000_0000_0001_0010_0011_0100
 PDX = 0xC0001234 &gt;&gt; 22 = 0x300 (768)
 PTX = (0xC0001234 &gt;&gt; 12) &amp; 0x3FF = 0x1
 PGOFF = 0xC0001234 &amp; 0xFFF = 0x234
</code></pre><h3 id="43-问题回答">4.3 问题回答 </h3>
<h4 id="q1-pde-和-pte-的结构">Q1: PDE 和 PTE 的结构？ </h4>
<p><strong>答</strong>：</p>
<p><strong>PDE (Page Directory Entry) 结构</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>PDE = 32 位
 ┌─────────────────────────────────┬───────────────┐
 │  页表物理地址 (20位)          │ 标志位 (12位) │
 └─────────────────────────────────┴───────────────┘
  [31:12]                           [11:0]
</code></pre><p><strong>标志位含义</strong>：</p>
<table>
<thead>
<tr>
<th>位</th>
<th>宏定义</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>PTE_P</td>
<td>Present：页表存在</td>
</tr>
<tr>
<td>1</td>
<td>PTE_W</td>
<td>Writeable：页表可写</td>
</tr>
<tr>
<td>2</td>
<td>PTE_U</td>
<td>User：用户可访问</td>
</tr>
<tr>
<td>3</td>
<td>PTE_PWT</td>
<td>Page Write-Through</td>
</tr>
<tr>
<td>4</td>
<td>PTE_PCD</td>
<td>Page Cache Disabled</td>
</tr>
<tr>
<td>5</td>
<td>PTE_A</td>
<td>Accessed：被访问过</td>
</tr>
<tr>
<td>6</td>
<td>PTE_D</td>
<td>Dirty：被修改过（仅PTE）</td>
</tr>
<tr>
<td>7</td>
<td>PTE_PS</td>
<td>Page Size（仅PDE）</td>
</tr>
</tbody>
</table>
<p><strong>PTE (Page Table Entry) 结构</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>PTE = 32 位
 ┌──────────────────────────────┬───────────────┐
 │  物理页地址 (20位)          │ 标志位 (12位) │
 └──────────────────────────────┴───────────────┘
  [31:12]                        [11:0]
</code></pre><h4 id="q2-页访问异常如何处理">Q2: 页访问异常如何处理？ </h4>
<p><strong>答</strong>：</p>
<p><strong>异常产生</strong>：</p>
<ul>
<li>虚拟地址对应的 PTE_P=0 时，CPU 检测到缺页</li>
<li>产生 Page Fault 异常（中断向量 #14）</li>
</ul>
<p><strong>错误码格式</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Error Code = 32 位
 ┌──────────────────────────────────────────────────┐
 │ ... (高28位) │ I │ R/W │ U/S │ P │ (低4位)      │
 └──────────────────────────────────────────────────┘
                [3] [2]   [1]   [0]
</code></pre><table>
<thead>
<tr>
<th>位</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 (P)</td>
<td>0=页不存在；1=权限冲突</td>
</tr>
<tr>
<td>1 (W/R)</td>
<td>0=读操作；1=写操作</td>
</tr>
<tr>
<td>2 (U/S)</td>
<td>0=内核态；1=用户态</td>
</tr>
<tr>
<td>3 (I)</td>
<td>0=页表；1=指令读取</td>
</tr>
</tbody>
</table>
<p><strong>硬件处理流程</strong>：</p>
<ol>
<li>检测到缺页异常</li>
<li>将故障虚拟地址保存到 CR2</li>
<li>将错误码压入栈</li>
<li>跳转到异常处理程序</li>
</ol>
<p><strong>软件处理流程</strong>：</p>
<ol>
<li>异常处理程序读取 CR2（故障地址）和错误码</li>
<li>根据错误码判断异常类型</li>
<li>分配新物理页</li>
<li>修改页表项</li>
<li>刷新 TLB</li>
<li>返回用户程序重试指令</li>
</ol>
<hr>
<h2 id="五-练习3页表项清除page_remove_pte">五、练习3：页表项清除（page_remove_pte） </h2>
<h3 id="51-实现">5.1 实现 </h3>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-inline">inline</span> <span class="token keyword keyword-void">void</span> <span class="token function">page_remove_pte</span><span class="token punctuation">(</span><span class="token class-name">pde_t</span> <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token class-name">uintptr_t</span> la<span class="token punctuation">,</span> <span class="token class-name">pte_t</span> <span class="token operator">*</span>ptep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptep <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">// (1) 检查PTE是否有效</span>
        <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">pte2page</span><span class="token punctuation">(</span><span class="token operator">*</span>ptep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// (2) 获取Page结构</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token function">page_ref_dec</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// (3) 减少引用计数</span>
            <span class="token function">free_page</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// (4) 引用计数为0时释放</span>
        <span class="token punctuation">}</span>
        <span class="token operator">*</span>ptep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                          <span class="token comment">// (5) 清除PTE</span>
        <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> la<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// (6) 刷新TLB</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="52-关键设计">5.2 关键设计 </h3>
<p><strong>引用计数的作用</strong>：</p>
<ul>
<li>Page 可能被多个虚拟地址映射（共享页）</li>
<li>只有当引用计数为0时才能释放物理页</li>
<li>示例：<pre data-role="codeBlock" data-info="" class="language-text"><code>Page X 被映射到虚拟地址 A 和 B
ref_count = 2

删除 A → B 的映射：
ref_count = 1，不释放

删除 A → B 的映射：
ref_count = 0，释放物理页
</code></pre></li>
</ul>
<p><strong>TLB 刷新的必要性</strong>：</p>
<ul>
<li>TLB 是 CPU 的虚拟地址缓存</li>
<li>修改页表后必须刷新对应的 TLB 条目</li>
<li>否则 CPU 使用过期的映射导致内存访问错误</li>
</ul>
<h3 id="53-问题回答">5.3 问题回答 </h3>
<h4 id="q1-page-与页表的对应关系">Q1: Page 与页表的对应关系？ </h4>
<p><strong>答</strong>：</p>
<p><strong>对应关系图</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Page 数组（全局）
  pages[0] ← → 物理页0
  pages[1] ← → 物理页1
  ...
  pages[i] ← → 物理页i
  ...
      ↕
  通过PTE_ADDR(*pte)/PGSIZE计算页索引
      ↕
  页表项中的物理地址
      ↕
  被某个虚拟地址映射到
</code></pre><p><strong>具体操作</strong>：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token comment">// 从 PTE 获取 Page</span>
<span class="token class-name">uintptr_t</span> pa <span class="token operator">=</span> <span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 提取物理地址</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>page <span class="token operator">=</span> pages <span class="token operator">+</span> pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">;</span>    <span class="token comment">// pages[物理页号]</span>

<span class="token comment">// 从 Page 获取物理地址</span>
<span class="token class-name">uintptr_t</span> pa <span class="token operator">=</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// = (page - pages) * PGSIZE</span>
</code></pre><p><strong>例子</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>假设 Page 数组地址 = 0xC010_0000
pages[0] 对应物理页 0（地址 0x00000000-0x00000FFF）
pages[1] 对应物理页 1（地址 0x00001000-0x00001FFF）
...

若虚拟地址 VA=0xC0001234 映射到物理页 1：
PTE 的值 = 0x00001XXX (物理页1的地址 + 权限位)
page = pages + (0x00001000 / 0x1000) = pages + 1
page = pages[1] ✓
</code></pre><h4 id="q2-虚拟地址等于物理地址如何实现">Q2: 虚拟地址等于物理地址如何实现？ </h4>
<p><strong>答</strong>：</p>
<p><strong>原理</strong>：<br>
通过页表建立恒等映射：虚拟地址 VA 映射到物理地址 PA = VA</p>
<p><strong>实现方式</strong>：<br>
修改 <code>pmm_init()</code> 中的页表建立代码：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token comment">// 原来：建立内核映射</span>
<span class="token comment">// 虚拟地址 0xC0000000 → 物理地址 0x00000000</span>
<span class="token function">boot_map_segment</span><span class="token punctuation">(</span>boot_pgdir<span class="token punctuation">,</span> KERNBASE<span class="token punctuation">,</span> KMEMSIZE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 改为：建立恒等映射</span>
<span class="token comment">// 虚拟地址 0x00000000 → 物理地址 0x00000000</span>
<span class="token function">boot_map_segment</span><span class="token punctuation">(</span>boot_pgdir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> KMEMSIZE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>对应关系</strong>：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>虚拟地址    物理地址
0x00000000  0x00000000
0x00001000  0x00001000
0xC0000000  0xC0000000 (超过物理内存，无效)
</code></pre><h2 id="六-知识点总结">六、知识点总结 </h2>
<h3 id="61-核心概念">6.1 核心概念 </h3>
<table>
<thead>
<tr>
<th>概念</th>
<th>含义</th>
<th>重要性</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>First-Fit</strong></td>
<td>首次适配算法</td>
<td>★★★★★</td>
</tr>
<tr>
<td><strong>页表</strong></td>
<td>虚→物映射</td>
<td>★★★★★</td>
</tr>
<tr>
<td><strong>TLB</strong></td>
<td>地址转换缓存</td>
<td>★★★★</td>
</tr>
<tr>
<td><strong>引用计数</strong></td>
<td>页面共享管理</td>
<td>★★★★</td>
</tr>
<tr>
<td><strong>标志位</strong></td>
<td>访问权限控制</td>
<td>★★★★</td>
</tr>
</tbody>
</table>
<h3 id="62-与操作系统原理的对应">6.2 与操作系统原理的对应 </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>课程知识点          Lab2实现
═══════════════════════════════════
内存分层           虚拟内存机制
内存管理策略       First-Fit算法
页面置换           page_remove_pte
虚拟内存           get_pte/page_insert
保护机制           标志位/权限
异常处理           Page Fault处理
</code></pre><h2 id="七-与参考答案对比">七、与参考答案对比 </h2>
<h3 id="71-实现的主要区别">7.1 实现的主要区别 </h3>
<table>
<thead>
<tr>
<th>方面</th>
<th>我的实现</th>
<th>参考答案</th>
<th>差异</th>
</tr>
</thead>
<tbody>
<tr>
<td>链表结构</td>
<td>按地址排序</td>
<td>按地址排序</td>
<td>✓ 相同</td>
</tr>
<tr>
<td>property字段</td>
<td>首页记录块大小</td>
<td>首页记录块大小</td>
<td>✓ 相同</td>
</tr>
<tr>
<td>合并策略</td>
<td>前向+后向</td>
<td>前向+后向</td>
<td>✓ 相同</td>
</tr>
<tr>
<td>代码风格</td>
<td>较清晰的注释</td>
<td>参考实现</td>
<td>基本相同</td>
</tr>
</tbody>
</table>
<h3 id="72-性能分析">7.2 性能分析 </h3>
<p><strong>时间复杂度</strong>：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody>
<tr>
<td>alloc_pages(n)</td>
<td>O(m)，m为块数</td>
</tr>
<tr>
<td>free_pages(n)</td>
<td>O(m)</td>
</tr>
<tr>
<td>创建PTE</td>
<td>O(1)</td>
</tr>
</tbody>
</table>
<p><strong>空间复杂度</strong>：O(n)，n为物理页数</p>
<h3 id="73-优点与不足">7.3 优点与不足 </h3>
<p><strong>优点</strong>：</p>
<ul>
<li>✓ 实现清晰易懂</li>
<li>✓ 功能完整正确</li>
<li>✓ 符合题目要求</li>
</ul>
<p><strong>不足</strong>：</p>
<ul>
<li>✗ 分配效率为 O(n)</li>
<li>✗ 无法处理大量碎片</li>
<li>✗ 未实现缓存优化</li>
</ul>
<hr>
<h2 id="八-测试结果">八、测试结果 </h2>
<h3 id="81-编译结果">8.1 编译结果 </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>$ <span class="token builtin class-name">cd</span> /home/dministrator/ucore/labcodes/lab2
$ <span class="token function">make</span> clean <span class="token operator">&amp;&amp;</span> <span class="token function">make</span>
<span class="token punctuation">..</span>.
ld bin/kernel         ✓ 编译通过
build <span class="token number">512</span> bytes boot sector: <span class="token string">'bin/bootblock'</span> success<span class="token operator">!</span>
</code></pre><h3 id="82-运行结果">8.2 运行结果 </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>$ make qemu
(THU.CST) os is loading ...

Special kernel symbols:
  entry  0xc010002a (phys)
  etext  0xc01060fb (phys)
  edata  0xc010a970 (phys)
  end    0xc010ba2c (phys)
Kernel executable memory footprint: 47KB
memory management: (null)

✓ 内核成功启动
✓ 内存管理系统初始化完成
</code></pre><h3 id="83-检查函数验证">8.3 检查函数验证 </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>check_alloc_page() succeeded!
check_pgdir() succeeded!
check_boot_pgdir() succeeded!
</code></pre><hr>
<h2 id="九-总结与反思">九、总结与反思 </h2>
<h3 id="91-实验收获">9.1 实验收获 </h3>
<ol>
<li>
<p><strong>深入理解内存管理</strong></p>
<ul>
<li>掌握了 First-Fit 算法的实现细节</li>
<li>理解了虚拟内存的映射原理</li>
<li>学会了链表数据结构的实际应用</li>
</ul>
</li>
<li>
<p><strong>x86 保护模式机制</strong></p>
<ul>
<li>理解了二级页表结构</li>
<li>掌握了虚拟地址转换过程</li>
<li>学会了标志位的含义和使用</li>
</ul>
</li>
<li>
<p><strong>系统级编程思维</strong></p>
<ul>
<li>学会了如何处理复杂的数据结构</li>
<li>理解了硬件与软件的交互</li>
<li>培养了调试和排查问题的能力</li>
</ul>
</li>
</ol>
<h3 id="92-遇到的困难">9.2 遇到的困难 </h3>
<ol>
<li>
<p><strong>链表操作</strong> - 初期对链表节点的嵌入理解不够</p>
<ul>
<li>解决：仔细阅读 list.h 和 le2page 宏定义</li>
</ul>
</li>
<li>
<p><strong>标志位管理</strong> - PDE/PTE 的标志位设置容易混淆</p>
<ul>
<li>解决：参考文档制作标志位对照表</li>
</ul>
</li>
<li>
<p><strong>内存合并逻辑</strong> - 前向和后向合并的边界条件</p>
<ul>
<li>解决：通过画图和 assert 验证</li>
</ul>
</li>
</ol>
<h3 id="93-改进方向">9.3 改进方向 </h3>
<ol>
<li>
<p><strong>性能优化</strong></p>
<ul>
<li>实现 Buddy System 以提高分配效率</li>
<li>添加分配位置缓存减少查找时间</li>
</ul>
</li>
<li>
<p><strong>功能扩展</strong></p>
<ul>
<li>实现 Slab Allocator 用于固定大小对象</li>
<li>添加内存碎片整理机制</li>
</ul>
</li>
<li>
<p><strong>安全性增强</strong></p>
<ul>
<li>添加越界检测</li>
<li>实现 Copy-On-Write 机制</li>
</ul>
</li>
</ol>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>